#!/usr/bin/env ruby
# Assumes the S3 bucket contains the same files as the ./fixtures/ folder

# Config
count = (ARGV[0] || 1000).to_i
s3_bucket = ENV['S3_BUCKET'] || 'numtide-nix-parallel-test-case'

# Main
top = File.expand_path('..', __dir__)
base_url="https://s3.amazonaws.com/#{s3_bucket}/fixtures"

pairs = count.times.map do |i|
  filename = "%03d.txt" % i
  url = "#{base_url}/#{filename}"
  sha256 = `nix-prefetch-url #{url}`.strip
  [url, sha256]
end

File.open("#{top}/fixtures.nix", "w") do |f|
  f.puts "["
  pairs.each do |(url, sha256)|
    f.puts <<EOF
  {
    url = "#{url}";
    sha256 = "#{sha256}";
  }
EOF
  end
  f.puts "]"
end
